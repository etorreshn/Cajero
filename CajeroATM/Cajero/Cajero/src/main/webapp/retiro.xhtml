<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core"
      lang="es">
<f:view>
    <h:head>
        <title>Retiro de Efectivo</title>
        <meta charset="UTF-8" />
        <style type="text/css">
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Arial', sans-serif;
            }

            body {
                background: linear-gradient(135deg, #1a2a3a, #2c3e50);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                padding: 20px;
            }

            .atm-machine {
                width: 800px;
                background: #2c3e50;
                border-radius: 20px;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
                overflow: hidden;
                border: 15px solid #34495e;
                position: relative;
            }

            .atm-header {
                background: #c0392b;
                color: white;
                padding: 15px 30px;
                text-align: center;
                border-bottom: 5px solid #922b21;
            }

            .atm-header h1 {
                font-size: 24px;
                font-weight: bold;
                letter-spacing: 1px;
            }

            .atm-body {
                display: flex;
                padding: 30px;
                background: #34495e;
                gap: 30px;
            }

            .screen-container {
                flex: 1;
                background: #1a252f;
                border-radius: 10px;
                padding: 20px;
                box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
            }

            .atm-screen {
                background: #8bb5e6;
                height: 400px;
                border-radius: 5px;
                padding: 25px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
                font-family: 'Courier New', monospace;
                color: #000;
                position: relative;
                overflow: hidden;
                text-align: center;
            }

            .screen-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(139, 181, 230, 0.7) 0%, rgba(139, 181, 230, 0.3) 100%);
                pointer-events: none;
            }

            .retiro-container {
                background: rgba(255, 255, 255, 0.9);
                padding: 30px;
                border-radius: 10px;
                border: 3px solid #2c3e50;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                width: 100%;
                max-width: 400px;
            }

            .retiro-titulo {
                font-size: 24px;
                font-weight: bold;
                color: #2c3e50;
                margin-bottom: 20px;
            }

            .saldo-info {
                font-size: 16px;
                color: #7f8c8d;
                margin-bottom: 20px;
                padding: 10px;
                background: #ecf0f1;
                border-radius: 5px;
            }

            .monto-input {
                font-size: 20px;
                padding: 12px;
                margin: 15px 0;
                width: 100%;
                text-align: center;
                border: 2px solid #2c3e50;
                border-radius: 5px;
                background: white;
            }

            .mensaje-retiro {
                font-size: 16px;
                font-weight: bold;
                margin: 15px 0;
                padding: 10px;
                border-radius: 5px;
                text-align: center;
                min-height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .mensaje-exito {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .mensaje-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .keypad-container {
                width: 300px;
                background: #2c3e50;
                border-radius: 10px;
                padding: 20px;
            }

            .keypad {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                margin-bottom: 20px;
            }

            .key {
                background: #ecf0f1;
                height: 60px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 22px;
                font-weight: bold;
                color: #2c3e50;
                box-shadow: 0 4px 0 #bdc3c7;
                cursor: pointer;
                transition: all 0.1s;
                user-select: none;
            }

            .key:active {
                transform: translateY(4px);
                box-shadow: 0 0 0 #bdc3c7;
            }

            .function-keys {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .func-key {
                background: #e67e22;
                height: 50px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
                font-weight: bold;
                color: white;
                box-shadow: 0 4px 0 #d35400;
                cursor: pointer;
                transition: all 0.1s;
                user-select: none;
            }

            .func-key:active {
                transform: translateY(4px);
                box-shadow: 0 0 0 #d35400;
            }

            .card-slot {
                width: 100%;
                height: 10px;
                background: #7f8c8d;
                margin: 20px 0;
                border-radius: 5px;
                position: relative;
            }

            .card-slot::after {
                content: "Inserte su tarjeta aquí";
                position: absolute;
                top: -15px;
                left: 0;
                right: 0;
                text-align: center;
                color: #ecf0f1;
                font-size: 12px;
            }

            .money-slot {
                width: 100%;
                height: 40px;
                background: #7f8c8d;
                margin: 20px 0;
                border-radius: 5px;
                position: relative;
            }

            .money-slot::after {
                content: "Retire su dinero aquí";
                position: absolute;
                top: -15px;
                left: 0;
                right: 0;
                text-align: center;
                color: #ecf0f1;
                font-size: 12px;
            }

            .money-slot-activo {
                background: #27ae60 !important;
                animation: parpadeo 2s infinite;
            }

            @keyframes parpadeo {
                0%, 100% { background: #27ae60; }
                50% { background: #2ecc71; }
            }

            .money-slot-activo::after {
                content: "¡RETIRE SU DINERO AHORA!" !important;
                color: white !important;
                font-weight: bold !important;
                font-size: 14px !important;
            }

            .receipt-slot {
                width: 80%;
                height: 5px;
                background: #7f8c8d;
                margin: 20px auto;
                border-radius: 5px;
                position: relative;
            }

            .receipt-slot::after {
                content: "Comprobante";
                position: absolute;
                top: -20px;
                left: 0;
                right: 0;
                text-align: center;
                color: #ecf0f1;
                font-size: 12px;
            }

            .atm-footer {
                background: #34495e;
                padding: 15px;
                text-align: center;
                color: #ecf0f1;
                font-size: 14px;
                border-top: 2px solid #2c3e50;
            }

            .hidden-submit {
                display: none;
            }
        </style>
    </h:head>

    <h:body>
        <f:event type="preRenderView" listener="#{loginBean.verificarAutenticacion}" />

        <div class="atm-machine">
            <div class="atm-header">
                <h1>BANCO MANCO - RETIRO DE EFECTIVO</h1>
            </div>

            <div class="atm-body">
                <div class="screen-container">
                    <div class="atm-screen">
                        <div class="screen-overlay"></div>

                        <h:panelGroup rendered="#{not empty loginBean.nombreCliente}">
                            <div class="retiro-container">
                                <div class="retiro-titulo">RETIRO DE EFECTIVO</div>

                                <div class="saldo-info">
                                    Cliente: #{loginBean.nombreCliente}<br/>
                                    Cuenta: #{loginBean.numeroCuenta}<br/>
                                    Saldo disponible: #{loginBean.saldoFormateado}
                                </div>

                                <h:form id="retiroForm">
                                    <!-- Pantalla normal de retiro -->
                                    <h:panelGroup rendered="#{not loginBean.retiroExitoso}">
                                        <div style="margin-bottom: 15px;">
                                            <label for="monto" style="font-size: 18px; font-weight: bold;">Monto a retirar (Lps.):</label>
                                            <h:inputText id="monto" value="#{loginBean.montoRetiro}"
                                                         styleClass="monto-input"
                                                         placeholder="0.00"/>
                                        </div>

                                        <h:panelGroup rendered="#{not empty loginBean.mensajeRetiro}">
                                            <div class="mensaje-retiro mensaje-error">
                                                #{loginBean.mensajeRetiro}
                                            </div>
                                        </h:panelGroup>

                                        <!-- Botones ocultos para las acciones -->
                                        <h:commandButton id="aceptarRetiro" value="Aceptar"
                                                         action="#{loginBean.realizarRetiro}"
                                                         styleClass="hidden-submit" />
                                        <h:commandButton id="cancelarRetiro" value="Cancelar"
                                                         action="#{loginBean.cancelarRetiro}"
                                                         styleClass="hidden-submit" />
                                    </h:panelGroup>

                                    <!-- Pantalla después de retiro exitoso -->
                                    <h:panelGroup rendered="#{loginBean.retiroExitoso}">
                                        <div class="mensaje-retiro mensaje-exito">
                                            #{loginBean.mensajeRetiro}
                                        </div>

                                        <!-- Botón oculto para finalizar -->
                                        <h:commandButton id="finalizarRetiro" value="Finalizar"
                                                         action="#{loginBean.finalizarRetiro}"
                                                         styleClass="hidden-submit" />
                                    </h:panelGroup>
                                </h:form>
                            </div>
                        </h:panelGroup>
                    </div>

                    <div class="card-slot"></div>
                    <div class="money-slot #{loginBean.mostrarRetireDinero ? 'money-slot-activo' : ''}"></div>
                    <div class="receipt-slot"></div>
                </div>

                <div class="keypad-container">
                    <div class="keypad">
                        <div class="key" data-value="1">1</div>
                        <div class="key" data-value="2">2</div>
                        <div class="key" data-value="3">3</div>
                        <div class="key" data-value="4">4</div>
                        <div class="key" data-value="5">5</div>
                        <div class="key" data-value="6">6</div>
                        <div class="key" data-value="7">7</div>
                        <div class="key" data-value="8">8</div>
                        <div class="key" data-value="9">9</div>
                        <div class="key" data-value=".">.</div>
                        <div class="key" data-value="0">0</div>
                        <div class="key" data-value="clear">C</div>
                    </div>

                    <div class="function-keys">
                        <div class="func-key" data-action="accept">Aceptar</div>
                        <div class="func-key" data-action="cancel">Cancelar</div>
                        <div class="func-key" data-action="correct">Corregir</div>
                        <div class="func-key" data-action="continue">Continuar</div>
                    </div>
                </div>
            </div>

            <div class="atm-footer">
                <p>Operación segura - Para emergencias llame al 0800-123-4567</p>
            </div>
        </div>

        <script type="text/javascript">
            //<![CDATA[
            // Variables para el control del teclado
            var currentInput = document.getElementById('retiroForm:monto');

            // Función para verificar si hay retiro exitoso
            function hayRetiroExitoso() {
                // Buscar el mensaje de éxito
                var mensajes = document.querySelectorAll('.mensaje-exito');
                for (var i = 0; i < mensajes.length; i++) {
                    if (mensajes[i].offsetParent !== null) {
                        return true;
                    }
                }
                return false;
            }

            // Función para manejar teclas numéricas
            var keys = document.querySelectorAll('.key[data-value]');
            for (var i = 0; i < keys.length; i++) {
                keys[i].addEventListener('click', function() {
                    // No permitir entrada si hay retiro exitoso
                    if (hayRetiroExitoso()) {
                        return;
                    }

                    var value = this.getAttribute('data-value');

                    if (value === 'clear') {
                        if (currentInput) {
                            currentInput.value = '';
                        }
                    } else {
                        if (currentInput) {
                            if (value === '.' && currentInput.value.includes('.')) {
                                return;
                            }
                            currentInput.value += value;
                        }
                    }

                    // Efecto visual
                    this.style.transform = 'translateY(4px)';
                    this.style.boxShadow = '0 0 0 #bdc3c7';
                    var self = this;
                    setTimeout(function() {
                        self.style.transform = '';
                        self.style.boxShadow = '0 4px 0 #bdc3c7';
                    }, 100);
                });
            }

            // Función para manejar botones de función
            var funcKeys = document.querySelectorAll('.func-key');
            for (var j = 0; j < funcKeys.length; j++) {
                funcKeys[j].addEventListener('click', function() {
                    var action = this.getAttribute('data-action');
                    var retiroExitoso = hayRetiroExitoso();

                    switch(action) {
                        case 'accept':
                            if (retiroExitoso) {
                                // Finalizar retiro
                                var finalizarBtn = document.getElementById('retiroForm:finalizarRetiro');
                                if (finalizarBtn) {
                                    finalizarBtn.click();
                                }
                            } else {
                                // Realizar retiro
                                if (currentInput && currentInput.value.trim() !== '') {
                                    var aceptarBtn = document.getElementById('retiroForm:aceptarRetiro');
                                    if (aceptarBtn) {
                                        aceptarBtn.click();
                                    }
                                }
                            }
                            break;
                        case 'cancel':
                            if (!retiroExitoso) {
                                var cancelarBtn = document.getElementById('retiroForm:cancelarRetiro');
                                if (cancelarBtn) {
                                    cancelarBtn.click();
                                }
                            }
                            break;
                        case 'correct':
                            if (!retiroExitoso && currentInput && currentInput.value.length > 0) {
                                currentInput.value = currentInput.value.slice(0, -1);
                            }
                            break;
                        case 'continue':
                            break;
                    }

                    // Efecto visual
                    this.style.transform = 'translateY(4px)';
                    this.style.boxShadow = '0 0 0 #d35400';
                    var selfFunc = this;
                    setTimeout(function() {
                        selfFunc.style.transform = '';
                        selfFunc.style.boxShadow = '0 4px 0 #d35400';
                    }, 100);
                });
            }

            // Enfocar el campo de monto al cargar
            document.addEventListener('DOMContentLoaded', function() {
                if (currentInput && !hayRetiroExitoso()) {
                    currentInput.focus();
                }
            });

            // SOLUCIÓN DE EMERGENCIA - Si no funciona el botón, redirigir automáticamente
            setInterval(function() {
                if (hayRetiroExitoso()) {
                    // Esperar 3 segundos y redirigir automáticamente
                    setTimeout(function() {
                        window.location.href = 'index.xhtml';
                    }, 3000);
                }
            }, 1000);
            //]]>
        </script>
    </h:body>
</f:view>
</html>